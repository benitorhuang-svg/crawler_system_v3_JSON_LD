# åŸ·è¡Œæ•ˆç‡å„ªåŒ– - æ±ºç­–èˆ‡å·¥ä½œè¡¨

> **æ—¥æœŸ**: 2026-01-29  
> **ç°½æ ¸**: SDD v2.7 Performance Optimization Initiative  
> **ç›®æ¨™ ROI**: 3x åŠ é€Ÿ + 80% ç©©å®šæ€§æå‡

---

## å¿«é€Ÿæ±ºç­–è¡¨

### Q: æ‡‰è©²ç«‹å³å¯¦æ–½å—ï¼Ÿ

| ç¶­åº¦ | è©•åˆ† | èªªæ˜ |
|------|------|------|
| **æŠ€è¡“é¢¨éšª** | ğŸŸ¢ ä½ | æ”¹å‹•ç¯„åœå°ï¼Œå‘å¾Œå…¼å®¹ |
| **å¯¦æ–½æˆæœ¬** | ğŸŸ¢ ä½ | 8 å°æ™‚å¯å®Œæˆ Phase 1 |
| **é æœŸæ”¶ç›Š** | ğŸŸ¢ é«˜ | 3x åå + ç©©å®šæ€§ +80% |
| **ä¾è³´é—œä¿‚** | ğŸŸ¢ ç„¡ | ä¸éœ€é¡å¤–æœå‹™ |
| **å›æ»¾é›£åº¦** | ğŸŸ¢ ç°¡å–® | Git revert å³å¯ |

### çµè«–

âœ… **å»ºè­°ç«‹å³é€²è¡Œ Phase 1 å¯¦æ–½**ï¼ˆ8 å°æ™‚å…§å®Œæˆï¼‰

---

## å¯¦æ–½å·¥ä½œè¡¨

### Phase 1: ç«‹å³å¯¦æ–½ (å„ªå…ˆç´š P0)

#### Task 1.1: å¢åŠ è‡ªé©æ‡‰ä¸¦ç™¼åº¦æ–¹æ³•

| é …ç›® | è©³æƒ… |
|------|------|
| **æª”æ¡ˆ** | `core/services/crawl_service.py` |
| **æ–¹æ³•** | æ–°å¢ `_get_concurrency_for_platform()` |
| **å·¥ä½œé‡** | 15 åˆ†é˜ |
| **é©—è­‰** | `test_adaptive_concurrency()` |
| **é¢¨éšª** | ç„¡ |

**æ­¥é©Ÿ:**
1. åœ¨ `CrawlService` é¡åˆ¥ä¸­æ·»åŠ æ–°æ–¹æ³•
2. æ¸¬è©¦ï¼š`pytest test/sdd/test_optimization.py::TestPhase1Optimization::test_adaptive_concurrency -v`
3. çµæœï¼šç¢ºä¿ Yes123 = 6, 104 = 10

**å®Œæˆæª¢æŸ¥:**
- [ ] æ–¹æ³•å¯¦ç¾
- [ ] å–®å…ƒæ¸¬è©¦é€šé
- [ ] ç„¡ lint è­¦å‘Š

---

#### Task 1.2: å„ªåŒ– run_platform() æ‡‰ç”¨è‡ªé©æ‡‰ä¸¦ç™¼åº¦

| é …ç›® | è©³æƒ… |
|------|------|
| **æª”æ¡ˆ** | `core/services/crawl_service.py` |
| **æ–¹æ³•** | ä¿®æ”¹ `run_platform()` |
| **å·¥ä½œé‡** | 20 åˆ†é˜ |
| **é©—è­‰** | æ—¥èªŒè¼¸å‡ºé©—è­‰ |
| **é¢¨éšª** | ä½ï¼ˆç„¡é‚è¼¯è®Šå‹•ï¼‰ |

**æ­¥é©Ÿ:**
1. ä¿®æ”¹ Semaphore åˆå§‹åŒ–ï¼š`sem = asyncio.Semaphore(self._get_concurrency_for_platform(platform))`
2. æ·»åŠ æ—¥èªŒï¼š`logger.info("platform_concurrency_set", ...)`
3. é‹è¡Œæ¸¬è©¦ç’°å¢ƒï¼Œé©—è­‰æ—¥èªŒè¼¸å‡º

**å®Œæˆæª¢æŸ¥:**
- [ ] ä»£ç¢¼ä¿®æ”¹
- [ ] æ—¥èªŒé©—è­‰é€šé
- [ ] ç„¡é‹è¡ŒéŒ¯èª¤

---

#### Task 1.3: é›†æˆ Throttler åˆ° CrawlService

| é …ç›® | è©³æƒ… |
|------|------|
| **æª”æ¡ˆ** | `core/services/crawl_service.py` |
| **æ–¹æ³•** | ä¿®æ”¹ `__init__()` + æ–°å¢ `_get_throttle_params()` |
| **å·¥ä½œé‡** | 20 åˆ†é˜ |
| **é©—è­‰** | `test_throttle_params()` |
| **é¢¨éšª** | ç„¡ |

**æ­¥é©Ÿ:**
1. åœ¨ `__init__()` æ·»åŠ  `self.throttler = Throttler()`
2. æ–°å¢æ–¹æ³• `_get_throttle_params(platform)` å¾ config è®€å–
3. å–®å…ƒæ¸¬è©¦é©—è­‰

**å®Œæˆæª¢æŸ¥:**
- [ ] Throttler åˆå§‹åŒ–
- [ ] _get_throttle_params() å¯¦ç¾
- [ ] å–®å…ƒæ¸¬è©¦é€šé

---

#### Task 1.4: æ›´æ–° _process_url_and_save() é›†æˆé™æµ

| é …ç›® | è©³æƒ… |
|------|------|
| **æª”æ¡ˆ** | `core/services/crawl_service.py` |
| **æ–¹æ³•** | ä¿®æ”¹ `_process_url_and_save()` |
| **å·¥ä½œé‡** | 45 åˆ†é˜ |
| **é©—è­‰** | `test_throttler_integration()` |
| **é¢¨éšª** | ä¸­ï¼ˆé‚è¼¯è®Šå‹•ï¼‰ä½†å®Œå…¨å‘å¾Œå…¼å®¹ |

**æ­¥é©Ÿ:**
1. åœ¨æ–¹æ³•é–‹é ­æ·»åŠ  Throttler æ¢ä»¶æª¢æŸ¥
2. åœ¨æˆåŠŸæ™‚èª¿ç”¨ `await self.throttler.report_success()`
3. åœ¨ 429 æ™‚èª¿ç”¨ `await self.throttler.report_429()`
4. é‹è¡Œæ•´åˆæ¸¬è©¦

**å®Œæˆæª¢æŸ¥:**
- [ ] Throttler èª¿ç”¨é›†æˆ
- [ ] 429 è™•ç†é‚è¼¯æ­£ç¢º
- [ ] æ—¥èªŒè¼¸å‡ºé©—è­‰
- [ ] æ•´åˆæ¸¬è©¦é€šé

---

#### Task 1.5: å…¨å±€ Fan-out - å„ªåŒ– run_all()

| é …ç›® | è©³æƒ… |
|------|------|
| **æª”æ¡ˆ** | `core/services/crawl_service.py` |
| **æ–¹æ³•** | ä¿®æ”¹ `run_all()` |
| **å·¥ä½œé‡** | 15 åˆ†é˜ |
| **é©—è­‰** | `test_fan_out_concurrency()` |
| **é¢¨éšª** | ä½ |

**æ­¥é©Ÿ:**
1. å°‡ for è¿´åœˆæ”¹ç‚º `asyncio.gather()`
2. æ·»åŠ ç•°å¸¸è™•ç†å’Œæ—¥èªŒ
3. é‹è¡Œä¸¦ç™¼æ¸¬è©¦

**å®Œæˆæª¢æŸ¥:**
- [ ] gather() å¯¦ç¾æ­£ç¢º
- [ ] ç•°å¸¸è™•ç†å®Œæ•´
- [ ] å¹¶è¡Œé©—è­‰é€šé

---

#### Task 1.6: æ›´æ–° config.py é™æµé…ç½®

| é …ç›® | è©³æƒ… |
|------|------|
| **æª”æ¡ˆ** | `core/infra/config.py` |
| **é…ç½®** | `THROTTLE_CONFIG` |
| **å·¥ä½œé‡** | 10 åˆ†é˜ |
| **é©—è­‰** | é…ç½®å€¼æª¢æŸ¥ |
| **é¢¨éšª** | ç„¡ |

**æ­¥é©Ÿ:**
1. æ›´æ–° THROTTLE_CONFIG ä¸­çš„é€Ÿç‡èˆ‡å®¹é‡
2. ç¢ºä¿ Yes123 é€Ÿç‡ â‰¤ 3.0

**å®Œæˆæª¢æŸ¥:**
- [ ] é…ç½®å€¼æ›´æ–°
- [ ] ç„¡èªæ³•éŒ¯èª¤

---

### Phase 1 ç¸½çµ

| Task | å®Œæˆæ ¸é¸ | è€—æ™‚ | é©—è­‰ |
|------|---------|------|------|
| 1.1 | â˜ | 15m | âœ“ unit |
| 1.2 | â˜ | 20m | âœ“ log |
| 1.3 | â˜ | 20m | âœ“ unit |
| 1.4 | â˜ | 45m | âœ“ integration |
| 1.5 | â˜ | 15m | âœ“ concurrent |
| 1.6 | â˜ | 10m | âœ“ config |
| **ç¸½è¨ˆ** | | **125m (~8h)** | |

---

## æ¸¬è©¦é©—è­‰è¨ˆåŠƒ

### Level 1: å–®å…ƒæ¸¬è©¦

```bash
# åŸ·è¡Œæ‰€æœ‰å„ªåŒ–ç›¸é—œæ¸¬è©¦
pytest test/sdd/test_optimization.py -v

# é æœŸçµæœï¼š
# âœ“ test_adaptive_concurrency
# âœ“ test_throttle_params
# âœ“ test_throttler_integration
# âœ“ test_fan_out_concurrency (async)
```

### Level 2: é›†æˆæ¸¬è©¦

```bash
# åœ¨é–‹ç™¼ç’°å¢ƒåŸ·è¡Œå°æ¨£çˆ¬å–
docker compose exec worker uv run python scripts/sample_test_sql.py --limit 20

# é©—è­‰æŒ‡æ¨™ï¼š
# - æ—¥èªŒå‡ºç¾ "platform_concurrency_set"
# - Yes123 ä¸¦ç™¼åº¦ = 6
# - 104 ä¸¦ç™¼åº¦ = 10
# - ç„¡ç•°å¸¸æ—¥èªŒ
```

### Level 3: æ€§èƒ½æ¸¬è©¦

```bash
# åŸ·è¡Œæ¨™æº–å°æ¨£æ¸¬è©¦ä¸¦è¨ˆæ™‚
time docker compose exec worker uv run python scripts/sample_test_sql.py --limit 50

# é æœŸçµæœï¼ˆvs åŸæœ‰ç³»çµ±ï¼‰ï¼š
# åŸ: ~60 åˆ†é˜ (ä¸²è¡Œ 5 å¹³å°)
# å„ªåŒ–å¾Œ: ~20 åˆ†é˜ (ä¸¦è¡ŒåŸ·è¡Œ)
# åŠ é€Ÿæ¯”: 3x
```

---

## ä¸Šç·šæª¢æŸ¥æ¸…å–®

### éƒ¨ç½²å‰æª¢æŸ¥

- [ ] æ‰€æœ‰ä»£ç¢¼ä¿®æ”¹å·²æäº¤è‡³ Git
- [ ] `pytest test/sdd/ -v` å…¨éƒ¨é€šé
- [ ] Redis é€£ç·šæ­£å¸¸
- [ ] è³‡æ–™åº«é€£ç·šæ­£å¸¸
- [ ] ç„¡ lint è­¦å‘Š (`uv run black core/`)
- [ ] ä»£ç¢¼å¯©æŸ¥å·²é€šé

### éƒ¨ç½²ç­–ç•¥

1. **é–‹ç™¼ç’°å¢ƒé©—è­‰** (1 å¤©)
   - éƒ¨ç½²å„ªåŒ–ä»£ç¢¼
   - åŸ·è¡Œ Level 1-3 æ¸¬è©¦
   - ç›£æ§æ—¥èªŒç„¡ç•°å¸¸

2. **ç°åº¦ç™¼å¸ƒ** (1 å¤©)
   - 50% æµé‡ä½¿ç”¨å„ªåŒ–ç‰ˆæœ¬
   - ç›£æ§æ€§èƒ½æŒ‡æ¨™å°æ¯”
   - æ¸¬è©¦ Yes123 ç­‰æ•æ„Ÿå¹³å°

3. **å…¨é‡ç™¼å¸ƒ** (å³åˆ»)
   - 100% æµé‡åˆ‡æ›è‡³å„ªåŒ–ç‰ˆæœ¬
   - æŒçºŒç›£æ§ 48 å°æ™‚

### ç·Šæ€¥å›æ»¾

è‹¥é‡åˆ°å•é¡Œï¼Œå›æ»¾æ­¥é©Ÿï¼š

```bash
git revert <commit-hash>  # å›æ»¾è‡³å„ªåŒ–å‰ç‰ˆæœ¬
docker compose restart worker
```

---

## é æœŸæˆæœ

### åŸ·è¡Œæ•ˆç‡æ”¹å–„

| æŒ‡æ¨™ | åŸæœ‰ | å„ªåŒ–å¾Œ | æ”¹é€² |
|------|------|--------|------|
| **å…¨é‡è€—æ™‚** | 60 min | 20 min | **3x** âš¡ |
| **å°æ¨£è€—æ™‚** | 15 min | 5 min | **3x** âš¡ |
| **å¹³å‡åå** | 40 jobs/min | 120 jobs/min | **+200%** ğŸ“ˆ |
| **è¢«å°é–ç‡** | 5-10% | < 1% | **+99%** âœ… |

### ç©©å®šæ€§æ”¹å–„

- âœ… Yes123 429 é€¢é‡ç‡: å¾ 8% â†’ < 1%
- âœ… è‡ªé©æ‡‰é™æµæˆåŠŸç‡: 99.5%+
- âœ… æ•…éšœè‡ªå‹•æ¢å¾©æ™‚é–“: 5-10 åˆ†é˜

---

## FAQ

### Q1: ç‚ºä»€éº¼ Yes123 ä¸¦ç™¼åº¦åªæœ‰ 6ï¼Ÿ

**A**: å¯¦æ¸¬ç™¼ç¾ Yes123 çš„é˜²çˆ¬æ©Ÿåˆ¶è¼ƒå¼·ï¼Œè¶…é 6 req/s æ™‚å®¹æ˜“è§¦ç™¼ 429ã€‚é€šéè‡ªé©æ‡‰é™æµï¼Œç³»çµ±æœƒåœ¨é­é‡ 429 å¾Œè‡ªå‹•é™é€Ÿï¼Œé¿å…è¢«å®Œå…¨å°é–ã€‚

### Q2: å¦‚æœ Throttler æ•…éšœæ€éº¼è¾¦ï¼Ÿ

**A**: `wait_for_slot()` åœ¨ Redis æ•…éšœæ™‚æœƒè¿”å› `True`ï¼ˆå‚¾å‘æ”¾è¡Œï¼‰ï¼Œç³»çµ±é™ç´šç‚ºç„¡é™æµä½†æ­£å¸¸é‹ä½œã€‚

### Q3: è¦æ”¹å‹• Docker é…ç½®å—ï¼Ÿ

**A**: ç„¡éœ€æ”¹å‹•ã€‚å„ªåŒ–å®Œå…¨åœ¨æ‡‰ç”¨å±¤ï¼Œä¸æ¶‰åŠå®¹å™¨æˆ–åŸºç¤è¨­æ–½è®Šæ›´ã€‚

### Q4: å¯ä»¥ A/B æ¸¬è©¦å—ï¼Ÿ

**A**: å¯ä»¥ã€‚åœ¨ `.env` ä¸­æ·»åŠ  `ENABLE_OPTIMIZATION_V2=true/false` é–‹é—œï¼Œå‹•æ…‹æ±ºå®šä½¿ç”¨åŸç‰ˆæˆ–å„ªåŒ–ç‰ˆæœ¬ã€‚

---

## ç°½æ ¸èˆ‡è¿½è¹¤

| è§’è‰² | ç°½æ ¸ | æ—¥æœŸ | å‚™è¨» |
|------|------|------|------|
| **æ¶æ§‹å¸«** | â˜ | | æ–¹æ¡ˆè©•ä¼° |
| **é–‹ç™¼è² è²¬äºº** | â˜ | | å¯¦æ–½è² è²¬ |
| **æ¸¬è©¦è² è²¬äºº** | â˜ | | é©—è­‰è¨ˆåŠƒ |
| **DevOps** | â˜ | | éƒ¨ç½²è¨ˆåŠƒ |

---

## åƒè€ƒæ–‡ä»¶

- [PERFORMANCE_OPTIMIZATION.md](PERFORMANCE_OPTIMIZATION.md) - è©³ç´°å„ªåŒ–æ–¹æ¡ˆ
- [OPTIMIZATION_PATCHES.md](OPTIMIZATION_PATCHES.md) - ä»£ç¢¼è£œä¸å¯¦ä½œ  
- [SDD_SDLC_SPEC.md](.rule/SDD_SDLC_SPEC.md) - SDD æ¶æ§‹è¦ç¯„

